<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Administrasi Guru</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD_LYfkdMYDNtb-0e7G-AIaAWGlqkwdxeI",
      authDomain: "workbook-7d27d.firebaseapp.com",
      projectId: "workbook-7d27d",
      storageBucket: "workbook-7d27d.firebasestorage.app",
      messagingSenderId: "943998083933",
      appId: "1:943998083933:web:d6ef2f9a26947ae13b3eb4",
      measurementId: "G-Z5RK0PRESH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.firebaseDB = db;
    window.firebaseAuth = auth;
    window.firebaseModules = {
      setDoc, getDoc, doc,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut
    };

    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .sidebar-item.active { background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); color: white; }
    .card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .input-field { border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px 16px; outline: none; transition: 0.3s; }
    .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
    .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; }
    .hidden { display: none !important; }
    .grid-pattern { background-image: linear-gradient(rgba(59, 130, 246, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(59, 130, 246, 0.05) 1px, transparent 1px); background-size: 20px 20px; }
  </style>
</head>
<body class="h-full bg-gray-50">

  <div id="auth-page" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
    <div class="grid-pattern absolute inset-0 opacity-20"></div>
    <div class="card w-full max-w-md p-8 relative z-10">
      <div class="text-center mb-8">
        <div id="auth-icon" class="w-20 h-20 bg-blue-600 rounded-2xl mx-auto mb-4 flex items-center justify-center text-4xl shadow-lg shadow-blue-200 transition-all">üìö</div>
        <h2 id="auth-title" class="text-3xl font-extrabold text-gray-800">Masuk Guru</h2>
        <p id="auth-subtitle" class="text-gray-500 mt-2">Kelola data administrasi kelas Anda</p>
      </div>
      <form id="auth-form" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
          <input type="email" id="auth-email" class="input-field w-full" placeholder="nama@sekolah.id" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Password</label>
          <input type="password" id="auth-password" class="input-field w-full" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" id="btn-auth" class="btn-primary w-full text-lg mt-2">Masuk Sekarang</button>
      </form>
      <div class="mt-6 text-center text-sm text-gray-600">
        <p id="auth-toggle-text">Belum punya akun? <button onclick="toggleAuthMode()" class="text-blue-600 font-bold hover:underline">Daftar Akun Baru</button></p>
      </div>
    </div>
  </div>

  <div id="app" class="h-full flex hidden">
    <aside id="sidebar" class="w-64 bg-white shadow-xl flex flex-col h-full fixed left-0 top-0 z-30">
      <div class="p-5 border-b border-gray-100">
        <div class="flex items-center gap-3">
          <div id="sidebar-logo" class="w-12 h-12 rounded-xl bg-blue-500 flex items-center justify-center text-white text-xl font-bold">üìö</div>
          <div>
            <h1 class="font-bold text-gray-800 leading-tight">Admin Guru</h1>
            <p class="text-xs text-gray-500">Sistem Terpadu</p>
          </div>
        </div>
      </div>
      <nav class="flex-1 p-4 overflow-y-auto">
        <ul class="space-y-2">
          <li><button onclick="navigateTo('dashboard')" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-page="dashboard"><span>üìä</span> Dashboard</button></li>
          <li><button onclick="navigateTo('profil')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-page="profil"><span>üè´</span> Profil</button></li>
          <li><button onclick="navigateTo('siswa')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-page="siswa"><span>üë®‚Äçüéì</span> Siswa</button></li>
          </ul>
      </nav>
      <div class="p-4 border-t border-gray-100">
        <div class="flex items-center gap-3 mb-4">
          <div id="teacher-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold overflow-hidden bg-blue-600"></div>
          <div class="flex-1 overflow-hidden">
            <p id="teacher-name" class="font-semibold text-sm text-gray-800 truncate">Guru</p>
            <p id="teacher-class" class="text-xs text-gray-500 truncate">Kelas -</p>
          </div>
        </div>
        <button onclick="logout()" class="w-full text-xs text-red-500 font-bold py-2 border border-red-100 rounded-lg hover:bg-red-50 transition-colors">üö™ Keluar Sistem</button>
      </div>
    </aside>

    <main class="flex-1 ml-64 h-full overflow-auto">
      <div id="page-dashboard" class="page p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard Utama</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="stats-container">
          <div class="card p-5 border-b-4 border-blue-500"><p class="text-sm text-gray-500">Total Siswa</p><p id="stat-siswa" class="text-3xl font-bold">0</p></div>
          </div>
      </div>

      <div id="page-profil" class="page p-6 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Profil Saya & Sekolah</h2>
        <div class="card p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium mb-1">Nama Wali Kelas</label><input type="text" id="nama-wali" class="input-field w-full"></div>
            <div><label class="block text-sm font-medium mb-1">Kelas yang Diampu</label><input type="text" id="kelas-diampu" class="input-field w-full"></div>
          </div>
          <button onclick="saveProfilData()" class="btn-primary">üíæ Simpan Perubahan</button>
        </div>
      </div>
    </main>
  </div>

  <div id="toast-container" class="fixed top-4 right-4 z-[200]"></div>

  <script>
    // ==================== STATE & AUTH ====================
    let appData = { profil: {}, siswa: [], presensi: {}, mapel: [], nilai: {}, jurnal: [], kas: { masuk: [], keluar: [] }, tabungan: [] };
    let currentUser = null;
    let isRegisterMode = false;

    async function initApp() {
      await new Promise(r => window.firebaseAuth ? r() : window.addEventListener('firebaseReady', r, {once:true}));
      const { onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.firebaseModules;
      const auth = window.firebaseAuth;

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          document.getElementById('auth-page').classList.add('hidden');
          document.getElementById('app').classList.remove('hidden');
          await loadAllDataFromFirebase();
        } else {
          currentUser = null;
          document.getElementById('auth-page').classList.remove('hidden');
          document.getElementById('app').classList.add('hidden');
        }
      });

      document.getElementById('auth-form').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const btn = document.getElementById('btn-auth');
        btn.disabled = true; btn.textContent = 'Memproses...';

        try {
          if (isRegisterMode) {
            await createUserWithEmailAndPassword(auth, email, password);
            showToast('Akun berhasil didaftarkan!', 'success');
          } else {
            await signInWithEmailAndPassword(auth, email, password);
            showToast('Berhasil masuk!', 'success');
          }
        } catch (error) {
          showToast('Gagal: ' + error.message, 'error');
        } finally {
          btn.disabled = false; btn.textContent = isRegisterMode ? 'Daftar Sekarang' : 'Masuk Sekarang';
        }
      };
    }

    function toggleAuthMode() {
      isRegisterMode = !isRegisterMode;
      document.getElementById('auth-title').textContent = isRegisterMode ? "Daftar Akun" : "Masuk Guru";
      document.getElementById('btn-auth').textContent = isRegisterMode ? "Daftar Sekarang" : "Masuk Sekarang";
      document.getElementById('auth-toggle-text').innerHTML = isRegisterMode ? 
        `Sudah punya akun? <button onclick="toggleAuthMode()" class="text-blue-600 font-bold hover:underline">Masuk di sini</button>` :
        `Belum punya akun? <button onclick="toggleAuthMode()" class="text-blue-600 font-bold hover:underline">Daftar Akun Baru</button>`;
    }

    async function logout() {
      await window.firebaseModules.signOut(window.firebaseAuth);
    }

    // ==================== DATA SYNC ====================
    async function loadAllDataFromFirebase() {
      if (!currentUser) return;
      const { doc, getDoc } = window.firebaseModules;
      try {
        const snap = await getDoc(doc(window.firebaseDB, 'userData', currentUser.uid));
        if (snap.exists()) Object.assign(appData, snap.data());
        refreshAllUI();
      } catch (e) { showToast('Gagal memuat data', 'error'); }
    }

    async function saveToFirebase(key, data) {
      if (!currentUser) return;
      appData[key] = data;
      const { doc, setDoc } = window.firebaseModules;
      try {
        await setDoc(doc(window.firebaseDB, 'userData', currentUser.uid), JSON.parse(JSON.stringify(appData)));
        refreshAllUI();
        return true;
      } catch (e) { showToast('Gagal menyimpan ke server', 'error'); }
    }

    // ==================== UI CORE ====================
    function navigateTo(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById(`page-${page}`).classList.remove('hidden');
      document.querySelectorAll('.sidebar-item').forEach(i => {
        i.classList.remove('active');
        if(i.dataset.page === page) i.classList.add('active');
      });
    }

    function refreshAllUI() {
      // Update Profil UI
      const p = appData.profil;
      document.getElementById('nama-wali').value = p.waliNama || '';
      document.getElementById('kelas-diampu').value = p.kelasDiampu || '';
      
      // Update Stats
      document.getElementById('stat-siswa').textContent = appData.siswa.length;
      
      // Update Sidebar Info & Inisial
      const name = p.waliNama || currentUser.email.split('@')[0];
      const initial = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0,2);
      document.getElementById('teacher-name').textContent = name;
      document.getElementById('teacher-class').textContent = p.kelasDiampu || 'Kelas -';
      document.getElementById('teacher-avatar').innerHTML = p.waliFoto ? 
        `<img src="${p.waliFoto}" class="w-full h-full object-cover">` : 
        `<div class="w-full h-full flex items-center justify-center bg-blue-600 text-white">${initial}</div>`;
    }

    async function saveProfilData() {
      const p = {
        waliNama: document.getElementById('nama-wali').value,
        kelasDiampu: document.getElementById('kelas-diampu').value
      };
      await saveToFirebase('profil', p);
      showToast('Profil diperbarui', 'success');
    }

    function showToast(msg, type) {
      const t = document.createElement('div');
      t.className = `p-4 mb-2 rounded-lg text-white shadow-lg ${type==='success'?'bg-green-500':'bg-red-500'}`;
      t.textContent = msg;
      document.getElementById('toast-container').appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    initApp();
  </script>
</body>
</html>
